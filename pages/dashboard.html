<div class="page-container" id="dashboard-page">
    <div class="dashboard-header">
        <div class="dashboard-title"
            style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
            <div>
                <h2 id="dashboard-region-title">India</h2>
                <div style="display: flex; align-items: baseline; gap: 10px;">
                    <span class="subtitle">Sales Dashboard</span>
                    <span id="last-updated-text" style="font-size: 0.8em; opacity: 0.7;"></span>
                </div>
            </div>
            <div class="header-controls" style="display: flex; gap: 10px; align-items: center;">
                <div class="data-source-container">
                    <select id="reportSelector" class="report-select">
                        <option value="" disabled selected>Loading Reports...</option>
                    </select>
                </div>
                <button id="manageReportBtn" class="btn-data btn-manage"
                    style="margin-left: 5px; background: var(--surface-2); border: 1px solid var(--border-light); color: var(--text-main);">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"
                        style="margin-right: 6px;">
                        <path d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                    Manage
                </button>
                <button id="uploadReportBtn" class="btn-data btn-upload">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        style="margin-right: 6px;">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    Upload
                </button>
                <button id="openDataInputBtn" class="btn-data">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        style="margin-right: 6px;">
                        <path d="M12 2c5.52 0 10 2 10 4.5S17.52 11 12 11 2 9 2 6.5 6.48 2 12 2z"></path>
                        <path d="M2 12.5C2 15 6.48 17 12 17s10-2 10-4.5"></path>
                        <path d="M2 6.5v11c0 2.5 4.48 4.5 10 4.5s10-2 10-4.5v-11"></path>
                    </svg>
                    Data
                </button>
            </div>
        </div>

        <!-- Injected Stats Grid -->
        <div class="kpi-grid" id="dashboard-stats">
            <!-- Stats inserted via JS -->
            <div class="kpi-card card-blue shimmer"></div>
            <div class="kpi-card card-orange shimmer"></div>
            <div class="kpi-card card-cyan shimmer"></div>
            <div class="kpi-card card-teal shimmer"></div>
            <div class="kpi-card card-purple shimmer"></div>
            <div class="kpi-card card-red shimmer"></div>
        </div>
    </div>

    <!-- Map Content -->
    <div class="dashboard-iframe-wrapper">
        <iframe src="pages/map.html" frameborder="0" class="dashboard-iframe" title="Sales Intelligence Map"></iframe>
    </div>

    <!-- Data Input Modal -->
    <div class="modal-overlay" id="dataInputModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Input Data</h3>
                <div style="flex:1"></div>
                <input type="hidden" id="sheetApiUrl"
                    value="https://script.google.com/macros/s/AKfycbwCS5-GtpPLFU1rKEKc9CnS81O1ebkzqKR1PkOYZSBe_Gxbi6KSZ96bRhyB3b0v9Hy2gw/exec">
                <button class="close-modal-btn" id="closeDataModalIcon">&times;</button>
            </div>
            <div class="modal-body">
                <div class="data-table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 20%">Scope</th>
                                <th style="width: 25%">Name</th>
                                <th style="width: 15%">Population</th>
                                <th style="width: 15%">GDP (Cr)</th>
                                <th style="width: 15%">Target (Cr)</th>
                                <th style="width: 50px"></th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                            <!-- Rows injected by JS -->
                        </tbody>
                    </table>
                </div>
                <button id="addRowBtn" class="btn-add-row" style="display: none;">+ Add Row</button>
            </div>
            <div class="modal-footer" style="justify-content: space-between;">
                <div class="sync-actions">
                    <span id="syncStatus"
                        style="font-size: 0.8rem; color: var(--text-muted); margin-left: 10px;"></span>
                </div>
                <div>
                    <button class="btn-cancel" id="closeDataModalBtn">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CSV Upload Modal -->
    <div class="modal-overlay" id="uploadModal">
        <div class="modal" style="width: 500px; min-height: auto;">
            <div class="modal-header">
                <h3>Upload Report</h3>
                <button class="close-modal-btn" id="closeUploadModalIcon">&times;</button>
            </div>
            <div class="modal-body" style="display: flex; flex-direction: column; gap: 15px;">
                <div class="form-group">
                    <label for="reportName"
                        style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 5px; display: block;">Report
                        Name</label>
                    <input type="text" id="reportName" placeholder="e.g. Sales 2023"
                        style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--bg-panel); color: var(--text-main);">
                </div>
                <div class="form-group">
                    <label for="csvFile"
                        style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 5px; display: block;">CSV
                        File</label>
                    <input type="file" id="csvFile" accept=".csv"
                        style="width: 100%; padding: 10px; border: 1px dashed var(--border-color); border-radius: 4px; color: var(--text-muted);">
                </div>
                <div id="uploadStatus" style="font-size: 0.9rem; color: var(--text-muted); min-height: 20px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" id="closeUploadModalBtn">Cancel</button>
                <button class="btn-data" id="submitUploadBtn"
                    style="background: var(--primary-color); color: white; border: none;">Upload & Save</button>
            </div>
        </div>
    </div>

    <!-- Manage Reports Modal -->
    <div class="modal-overlay" id="manageModal">
        <div class="modal" style="width: 500px; min-height: auto;">
            <div class="modal-header">
                <h3>Manage Reports</h3>
                <button class="close-modal-btn" id="closeManageModalIcon">&times;</button>
            </div>
            <div class="modal-body">
                <div id="reportsList" class="reports-list"
                    style="display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto;">
                    <!-- Dynamic Items -->
                </div>
                <div id="manageStatus" class="status-msg" style="margin-top: 10px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-data" id="closeManageModalBtn"
                    style="background: var(--primary-color); color:white;">Done</button>
            </div>
        </div>
    </div>
</div>

</div>
</div>

<script type="module" src="js/data_manager.js"></script>
<script type="module">
    console.log('Dashboard script loaded');

    // --- CSV Upload & Selection Logic ---
    // Import DataManager if not globally available, but we attached it to window in the class file.
    // Since it's a module running in order, window.DataManager should be set.

    import { storage } from './js/services/firebase_config.js'; // Optional verification import

    const initDashboard = async () => {
        // Ensure DataManager is ready
        if (typeof DataManager === 'undefined') {
            console.warn('DataManager not loaded yet, retrying...');
            setTimeout(initDashboard, 100);
            return;
        }

        const dm = new DataManager();
        const reportSelector = document.getElementById('reportSelector');
        const uploadBtn = document.getElementById('uploadReportBtn');
        const modal = document.getElementById('uploadModal');
        const closeIcon = document.getElementById('closeUploadModalIcon');
        const closeBtn = document.getElementById('closeUploadModalBtn');
        const submitBtn = document.getElementById('submitUploadBtn');
        const statusDiv = document.getElementById('uploadStatus');
        const nameInput = document.getElementById('reportName');
        const fileInput = document.getElementById('csvFile');

        if (!uploadBtn) {
            console.error('Upload button not found');
            return;
        }

        console.log('Initializing Dashboard Logic');

        // Load Reports
        async function loadReports() {
            try {
                const reports = await dm.listReports();

                // Clear existing options
                reportSelector.innerHTML = '';

                if (reports.length === 0) {
                    reportSelector.innerHTML = '<option value="" disabled selected>No Reports Available</option>';
                    return;
                }

                // Add reports
                reports.forEach(report => {
                    const opt = document.createElement('option');
                    opt.value = report.url;
                    // Date removed from display as per request
                    opt.textContent = report.name;
                    reportSelector.appendChild(opt);
                });

                // Auto Select Top if available
                if (reports.length > 0) {
                    const firstReportUrl = reports[0].url;
                    reportSelector.value = firstReportUrl;

                    // Improve Auto-Load: Wait for Map, then Trigger
                    waitForMapAndLoad(firstReportUrl);
                }
            } catch (e) {
                console.error('Failed to list reports:', e);
            }
        }

        function waitForMapAndLoad(url) {
            // Check if map is ready
            const iframe = document.querySelector('.dashboard-iframe');
            if (iframe && iframe.contentWindow && iframe.contentWindow.viewController) {
                console.log('Map Ready, triggering initial load...');
                // Trigger Change manually or call load logic directly?
                // Better to dispatch the event so the listener handles it
                reportSelector.dispatchEvent(new Event('change'));
            } else {
                console.log('Waiting for Map...');
                setTimeout(() => waitForMapAndLoad(url), 500);
            }
        }

        // --- MANAGE MODAL LOGIC ---
        const manageBtn = document.getElementById('manageReportBtn');
        const manageModal = document.getElementById('manageModal');
        const closeManageIcon = document.getElementById('closeManageModalIcon');
        const closeManageBtn = document.getElementById('closeManageModalBtn');
        const reportsListContainer = document.getElementById('reportsList');

        let currentReports = [];

        async function renderManageList() {
            try {
                currentReports = await dm.listReports();
                reportsListContainer.innerHTML = '';

                if (currentReports.length === 0) {
                    reportsListContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-main);">No reports uploaded.</div>';
                    return;
                }

                currentReports.forEach((report, index) => {
                    const row = document.createElement('div');
                    row.className = 'report-row';

                    const date = new Date(report.timeCreated).toLocaleDateString();

                    // Simple inline SVG icons for up/down/delete to avoid external dependency issues
                    row.innerHTML = `
                        <div class="info" style="display: flex; flex-direction: column;">
                            <span class="name">${report.name}</span>
                            <span class="date">${date}</span>
                        </div>
                        <div class="actions" style="display: flex; gap: 5px;">
                             <button class="btn-icon btn-rename" data-idx="${index}" style="padding: 5px; background: none; border: none; color: var(--text-main); cursor: pointer; font-size: 1.2em;" title="Rename">
                                ✎
                            </button>
                            <button class="btn-icon btn-up" data-idx="${index}" ${index === 0 ? 'disabled' : ''} style="padding: 5px; background: none; border: none; color: var(--text-main); cursor: pointer; opacity: ${index === 0 ? 0.3 : 1}; font-size: 1.2em;">
                                ▲
                            </button>
                            <button class="btn-icon btn-down" data-idx="${index}" ${index === currentReports.length - 1 ? 'disabled' : ''} style="padding: 5px; background: none; border: none; color: var(--text-main); cursor: pointer; opacity: ${index === currentReports.length - 1 ? 0.3 : 1}; font-size: 1.2em;">
                                ▼
                            </button>
                            <button class="btn-icon btn-del" data-idx="${index}" style="padding: 5px; background: none; border: none; color: #ff4d4d; cursor: pointer; margin-left: 10px; font-weight: bold;">
                                ✖
                            </button>
                        </div>
                    `;
                    reportsListContainer.appendChild(row);
                });

                // Attach Listeners
                document.querySelectorAll('.btn-rename').forEach(btn => btn.addEventListener('click', handleRename));
                document.querySelectorAll('.btn-up').forEach(btn => btn.addEventListener('click', (e) => moveReport(e, -1)));
                document.querySelectorAll('.btn-down').forEach(btn => btn.addEventListener('click', (e) => moveReport(e, 1)));
                document.querySelectorAll('.btn-del').forEach(btn => btn.addEventListener('click', deleteReport));

            } catch (e) {
                console.error('List failed', e);
            }
        }

        async function handleRename(e) {
            const btn = e.target.closest('button');
            if (!btn) return;
            const index = parseInt(btn.dataset.idx);
            const report = currentReports[index];

            const newName = prompt("Enter new name:", report.name);
            if (newName && newName.trim() !== "" && newName !== report.name) {
                await dm.renameReport(report, newName.trim());
                await renderManageList();
                await loadReports();
            }
        }

        async function moveReport(e, direction) {
            const btn = e.target.closest('button');
            if (!btn) return;
            const index = parseInt(btn.dataset.idx);

            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= currentReports.length) return;

            // Swap
            const temp = currentReports[index];
            currentReports[index] = currentReports[newIndex];
            currentReports[newIndex] = temp;

            await dm.saveReportsList(currentReports);
            await renderManageList();
            await loadReports();
        }

        async function deleteReport(e) {
            const btn = e.target.closest('button');
            if (!btn) return;
            const index = parseInt(btn.dataset.idx);
            const report = currentReports[index];

            if (!confirm(`Delete "${report.name}"?`)) return;

            await dm.deleteReport(report);
            await renderManageList();
            await loadReports();
        }

        if (manageBtn) {
            manageBtn.addEventListener('click', () => {
                console.log('Manage Button Clicked');
                manageModal.classList.add('active');
                renderManageList();
            });
        } else {
            console.error('Manage Button NOT Found');
        }

        const closeManageModal = () => manageModal.classList.remove('active');
        if (closeManageIcon) closeManageIcon.addEventListener('click', closeManageModal);
        if (closeManageBtn) closeManageBtn.addEventListener('click', closeManageModal);


        // --- UPLOAD MODAL LOGIC ---
        uploadBtn.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('Upload button clicked');
            modal.classList.add('active');
        });

        const closeUploadModal = () => {
            modal.classList.remove('active');
            statusDiv.textContent = '';
            nameInput.value = '';
            fileInput.value = '';
        };

        if (closeIcon) closeIcon.addEventListener('click', closeUploadModal);
        if (closeBtn) closeBtn.addEventListener('click', closeUploadModal);

        if (submitBtn) {
            submitBtn.addEventListener('click', async () => {
                const file = fileInput.files[0];
                const name = nameInput.value.trim();

                if (!file || !name) {
                    statusDiv.textContent = 'Please provide both a name and a file.';
                    statusDiv.style.color = 'var(--text-error)';
                    return;
                }

                try {
                    statusDiv.textContent = 'Uploading...';
                    statusDiv.style.color = 'var(--text-main)';
                    submitBtn.disabled = true;

                    await dm.uploadCSV(file, name);

                    statusDiv.textContent = 'Upload Successful!';
                    statusDiv.style.color = 'var(--text-success)';

                    await loadReports();
                    setTimeout(() => {
                        closeUploadModal();
                        submitBtn.disabled = false;
                    }, 1000);

                } catch (e) {
                    statusDiv.textContent = 'Error: ' + e.message;
                    statusDiv.style.color = 'var(--text-error)';
                    submitBtn.disabled = false;
                }
            });
        }

        // --- SELECTION LOGIC ---
        reportSelector.addEventListener('change', async (e) => {
            const val = e.target.value;
            console.log('Report selected:', val);

            const iframe = document.querySelector('.dashboard-iframe');

            if (iframe && iframe.contentWindow && iframe.contentWindow.viewController) {
                const mapVC = iframe.contentWindow.viewController;
                const mapDM = mapVC.dataManager;

                try {
                    if (val) {
                        await mapDM.loadData('Kerala', [], val);
                    }
                    await mapVC.loadIndiaOverview();

                    if (mapVC.currentView === 'india') {
                        mapVC.handleViewChange(document.getElementById('view-selector')?.value || 'states');
                    } else {
                        mapVC.showIndiaView();
                    }
                } catch (err) {
                    console.error('Error switching report:', err);
                    alert('Failed to load report: ' + err.message);
                }
            } else {
                console.error('Map Controller not ready yet.');
            }
        });

        // Trigger Initial Load LAST, after all listeners are set
        await loadReports();

        // Display Last Updated Date from Storage
        try {
            const lastUpdate = await dm.getLastStorageUpdate();
            console.log('Last Update Time Fetched:', lastUpdate); // Debug Log

            if (lastUpdate) {
                const dateStr = new Date(lastUpdate).toLocaleDateString([], { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                const dateEl = document.getElementById('last-updated-text');
                if (dateEl) {
                    dateEl.textContent = `(Updated: ${dateStr})`;
                    console.log('UI Updated with date:', dateStr);
                } else {
                    console.error('Date Element #last-updated-text not found!');
                }
            }
        } catch (e) {
            console.warn('Could not fetch last update time:', e);
        }
    };

    // Run initialization
    initDashboard();

    // Helper for robust key matching (Moved to top for scope safety)
    function normalizeName(name) {
        if (!name) return '';
        return name.toLowerCase().trim().replace(/[^a-z0-9]/g, '');
    }

    let lastReceivedStats = null;

    // Separate Render Function to avoid race conditions
    function renderStats(data) {
        if (!data) return;
        lastReceivedStats = data; // Keep latest copy

        const container = document.getElementById('dashboard-stats');
        if (!container) return;

        // Merge Data Logic
        const entityName = data.name; // e.g. "Kerala", "India"
        let key = normalizeName(entityName);
        if (key === 'panindia') key = 'india';

        let tableInfo = window.dashboardDataCache ? window.dashboardDataCache[key] : null;

        // Fallbacks/Overrides
        // Population
        let displayPop = tableInfo && tableInfo.pop ? tableInfo.pop : (data.name === 'India' || data.name === 'Pan India' ? '144 Cr' : 'N/A');

        // GDP
        let displayGDP = tableInfo && tableInfo.gdp ? tableInfo.gdp : 'N/A';

        // Target
        let displayTargetStr = tableInfo && tableInfo.target ? tableInfo.target : formatCurrency(data.monthlyTarget);
        let targetVal = parseFloat((displayTargetStr + '').replace(/[^0-9.]/g, ''));

        // Achievement Calculation
        let displayAchievement = '0%';
        if (tableInfo && tableInfo.target && targetVal > 0) {
            // Assuming map sales is raw Rupees, and Table Target is in Crores (as per header)
            // 1 Crore = 10,000,000
            let salesCr = data.currentSales / 10000000;
            let ach = (salesCr / targetVal) * 100;
            displayAchievement = ach.toFixed(1) + '%';
        } else {
            displayAchievement = formatNumber(data.achievement) + '%';
        }

        // Update dashboard title
        const titleElement = document.getElementById('dashboard-region-title');
        if (titleElement) {
            // Replace 'Pan India' with just 'India'
            let displayName = data.name || 'India';
            if (displayName === 'Pan India') {
                displayName = 'India';
            }
            titleElement.textContent = displayName;
        }

        container.innerHTML = `
            <!-- Population -->
            <div class="kpi-card card-blue">
                <div class="kpi-content">
                    <span class="kpi-value">${displayPop}</span>
                    <span class="kpi-label">Population</span>
                </div>
            </div>

            <!-- GDP (New) -->
            <div class="kpi-card card-teal">
                <div class="kpi-content">
                    <span class="kpi-value">${displayGDP}</span>
                    <span class="kpi-label">GDP</span>
                </div>
            </div>

            <!-- Dealers -->
            <div class="kpi-card card-orange">
                <div class="kpi-content">
                    <span class="kpi-value">${data.dealerCount}</span>
                    <span class="kpi-label">Active Dealers</span>
                </div>
            </div>

            <!-- Target -->
            <div class="kpi-card card-red">
                <div class="kpi-content">
                    <span class="kpi-value">${displayTargetStr}</span>
                    <span class="kpi-label">Target</span>
                </div>
            </div>

            <!-- Sales -->
            <div class="kpi-card card-cyan">
                <div class="kpi-content">
                    <span class="kpi-value">₹${formatCurrency(data.currentSales)}</span>
                    <span class="kpi-label">Total Sales</span>
                </div>
            </div>

            <!-- Achievement -->
            <div class="kpi-card card-purple">
                <div class="kpi-content">
                    <span class="kpi-value">${displayAchievement}</span>
                    <span class="kpi-label">Achievement</span>
                </div>
            </div>
        `;
    }

    window.addEventListener('message', function (event) {
        if (event.data.type === 'STATS_UPDATE') {
            renderStats(event.data.data);
        }
    });

    function formatNumber(num) {
        if (!num) return '0';
        return parseFloat(num).toFixed(1);
    }

    function formatCurrency(val) {
        if (!val) return '0';
        let num = parseFloat(val);
        if (isNaN(num)) return val;
        // Indian Number System
        if (num >= 10000000) return (num / 10000000).toFixed(2) + ' Cr';
        else if (num >= 100000) return (num / 100000).toFixed(2) + ' L';
        else if (num >= 1000) return (num / 1000).toFixed(1) + ' k';
        return num.toFixed(0);
    }

    // Data Constants

    const STATES_LIST = [
        "Andaman and Nicobar Islands", "Andhra Pradesh", "Arunachal Pradesh", "Assam", "Bihar",
        "Chandigarh", "Chhattisgarh", "Dadra and Nagar Haveli and Daman and Diu", "Delhi", "Goa", "Gujarat",
        "Haryana", "Himachal Pradesh", "Jammu and Kashmir", "Jharkhand", "Karnataka", "Kerala",
        "Ladakh", "Lakshadweep", "Madhya Pradesh", "Maharashtra", "Manipur", "Meghalaya", "Mizoram",
        "Nagaland", "Odisha", "Puducherry", "Punjab", "Rajasthan", "Sikkim", "Tamil Nadu",
        "Telangana", "Tripura", "Uttar Pradesh", "Uttarakhand", "West Bengal"
    ];

    const KERALA_DISTRICTS_LIST = [
        "Alappuzha", "Ernakulam", "Idukki", "Kannur", "Kasaragod", "Kollam", "Kottayam",
        "Kozhikode", "Malappuram", "Palakkad", "Pathanamthitta", "Thiruvananthapuram", "Thrissur", "Wayanad"
    ];

    // Data Modal Logic
    const modal = document.getElementById('dataInputModal');
    const openBtn = document.getElementById('openDataInputBtn');
    const closeIcon = document.getElementById('closeDataModalIcon');
    const closeBtn = document.getElementById('closeDataModalBtn');
    const tableBody = document.getElementById('dataTableBody');

    function openModal() {
        if (modal) {
            modal.classList.add('active');
            if (getApiUrl(true)) {
                // Auto-sync on open if connected
                downloadSheet();
            } else if (tableBody && tableBody.children.length === 0) {
                populateTable();
            }
        }
    }

    function closeModal() {
        if (modal) modal.classList.remove('active');
    }

    function populateTable() {
        // 1. India Row
        addRow('india', 'India');

        // 2. States
        STATES_LIST.forEach(state => {
            addRow('state', state);
        });

        // 3. Kerala Districts
        KERALA_DISTRICTS_LIST.forEach(dist => {
            addRow('district', dist);
        });
    }

    function addRow(scope, name) {
        const tr = document.createElement('tr');

        let scopeLabel = scope === 'india' ? 'India' : (scope === 'state' ? 'State' : 'Kerala District');

        tr.innerHTML = `
            <td>
                <input type="text" value="${scopeLabel}" disabled style="opacity: 0.7; font-weight: 500;">
                <input type="hidden" class="row-scope" value="${scope}">
            </td>
            <td>
                <input type="text" class="row-name" value="${name}" disabled style="opacity: 0.9; font-weight: 600;">
            </td>
            <td><input type="text" class="row-pop" placeholder="0"></td>
            <td><input type="text" class="row-gdp" placeholder="0"></td>
            <td><input type="text" class="row-target" placeholder="0"></td>
            <td class="action-cell">
                <!-- No delete for preset rows -->
            </td>
        `;
        tableBody.appendChild(tr);
    }

    // Expose to window for inline onclicks
    window.deleteRow = function (btn) {
        // ... previous logic if needed, but we hid the delete button for preset rows
        // Keeping implementation in case we re-enable dynamic rows later
        const row = btn.closest('tr');
        if (tableBody.children.length > 1) {
            row.remove();
        }
    }

    // --- Realtime / Auto-Sync Logic ---

    // Debounce Utility
    function debounce(func, wait) {
        let timeout;
        return function (...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
        };
    }

    // Auto-Upload Handler (Debounced)
    const autoUpload = debounce(() => {
        if (getApiUrl(true)) { // Pass true to suppress alert if just typing
            syncSheet('upload');
        }
    }, 2000); // 2 seconds delay

    // Attach Input Listeners for Auto-Upload
    if (tableBody) {
        tableBody.addEventListener('input', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                setSyncStatus('Saving...', 'normal');
                autoUpload();
            }
        });
    }

    window.handleScopeChange = function (select) {
        const row = select.closest('tr');
        const nameSelect = row.querySelector('.row-name');
        const val = select.value;

        nameSelect.disabled = false;

        if (val === 'india') {
            nameSelect.value = 'India';
            nameSelect.disabled = true;
        }
        // Note: For preset table, we don't actually need to change options dynamically 
        // because we hardcoded the rows with correct names.
        // This function is kept for potential dynamic rows or correcting manual changes.
    }

    // --- Google Sheets Sync Logic ---
    const syncStatus = document.getElementById('syncStatus');
    const apiUrlInput = document.getElementById('sheetApiUrl');

    function getApiUrl(suppressAlert = false) {
        const url = apiUrlInput.value.trim();
        if (!url) {
            if (!suppressAlert) alert('Please enter your Google Apps Script Web App URL first.');
            return null;
        }
        return url;
    }

    function setSyncStatus(msg, type = 'info') {
        syncStatus.textContent = msg;
        syncStatus.style.color = type === 'error' ? '#ef4444' : (type === 'success' ? '#22c55e' : 'var(--text-muted)');
    }

    function getTableData() {
        const rows = [];
        document.querySelectorAll('#dataTableBody tr').forEach(tr => {
            rows.push({
                scope: tr.querySelector('.row-scope').value,
                name: tr.querySelector('.row-name').value,
                population: tr.querySelector('.row-pop').value,
                gdp: tr.querySelector('.row-gdp').value,
                target: tr.querySelector('.row-target').value
            });
        });
        return rows;
    }

    async function syncSheet(action) {
        const url = getApiUrl();
        if (!url) return;

        setSyncStatus(action === 'initialize' ? 'Initializing...' : 'Uploading...');

        try {
            let dataToSend;

            if (action === 'initialize') {
                dataToSend = [];
                // 1. India
                dataToSend.push({ scope: 'india', name: 'India', population: '', gdp: '', target: '' });

                // 2. States
                STATES_LIST.forEach(state => {
                    dataToSend.push({ scope: 'state', name: state, population: '', gdp: '', target: '' });
                });

                // 3. Kerala Districts
                KERALA_DISTRICTS_LIST.forEach(dist => {
                    dataToSend.push({ scope: 'district', name: dist, population: '', gdp: '', target: '' });
                });
            } else {
                // For upload, read from table
                dataToSend = getTableData();
            }

            const payload = {
                action: action,
                data: dataToSend
            };

            // Using no-cors might block reading response in some cases, but GAS supports CORS if implemented right.
            // However, typical simple POST to GAS often requires standard fetch.
            // If CORS issues arise, we might need a workaround or ensure GAS script returns correct headers (it usually does for Web Apps).
            const response = await fetch(url, {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8', // Plain text to avoid OPTIONS preflight issues with GAS
                },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            if (result.status === 'success') {
                setSyncStatus(result.message || 'Success!', 'success');
            } else {
                setSyncStatus('Error: ' + (result.error || 'Unknown'), 'error');
            }
        } catch (e) {
            console.error(e);
            setSyncStatus('Network/CORS Error. Check Console.', 'error');
        }
    }

    async function downloadSheet() {
        const url = getApiUrl();
        if (!url) return;

        setSyncStatus('Downloading...');
        try {
            // Changed to POST to avoid doGet conflicts in Apps Script
            const response = await fetch(url, {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8',
                },
                body: JSON.stringify({ action: 'download' })
            });

            const result = await response.json();

            if (result.status === 'success') {
                updateTable(result.data);
                setSyncStatus('Data loaded!', 'success');
            } else {
                setSyncStatus('Error: ' + (result.error || 'Unknown'), 'error');
            }
        } catch (e) {
            console.error(e);
            setSyncStatus('Download failed.', 'error');
        }
    }

    function updateTable(data) {
        tableBody.innerHTML = ''; // Clear current
        window.dashboardDataCache = {}; // Reset cache

        data.forEach(row => {
            // Cache data for dashboard ID match
            if (row.name) {
                const key = normalizeName(row.name);
                window.dashboardDataCache[key] = {
                    pop: row.population,
                    gdp: row.gdp,
                    target: row.target
                };
            }

            // Re-create row structure.
            // Note: Since we are loading arbitrary data, we might assume standard structure.
            // We use the helper but passing raw values.
            const tr = document.createElement('tr');

            // Map scope label for display
            let scopeLabel = row.scope === 'india' ? 'India' : (row.scope === 'state' ? 'State' : (row.scope === 'district' ? 'Kerala District' : row.scope));

            tr.innerHTML = `
                <td>
                    <input type="text" value="${scopeLabel}" disabled style="opacity: 0.7; font-weight: 500;">
                    <input type="hidden" class="row-scope" value="${row.scope}">
                </td>
                <td>
                    <input type="text" class="row-name" value="${row.name}" disabled style="opacity: 0.9; font-weight: 600;">
                </td>
                <td><input type="text" class="row-pop" value="${row.population}" placeholder="0"></td>
                <td><input type="text" class="row-gdp" value="${row.gdp}" placeholder="0"></td>
                <td><input type="text" class="row-target" value="${row.target}" placeholder="0"></td>
                <td class="action-cell"></td>
            `;
            tableBody.appendChild(tr);
        });

        // Race condition fix: Re-render dashboard if map already sent stats
        if (lastReceivedStats) {
            console.log('Cache populated, re-rendering stats...');
            renderStats(lastReceivedStats);
        }
    }



    if (openBtn) openBtn.addEventListener('click', openModal);
    if (closeIcon) closeIcon.addEventListener('click', closeModal);
    if (closeBtn) closeBtn.addEventListener('click', closeModal);
    if (addRowBtn) addRowBtn.addEventListener('click', () => addRow('state', 'New State')); // Placeholder logic just in case

    // Auto-fetch on load (works with SPA navigation)
    function initDashboardData() {
        if (getApiUrl(true)) {
            console.log('Auto-fetching dashboard data...');
            downloadSheet();
        }
    }

    // Check if already loaded (for SPA) or wait for DOMContentLoaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initDashboardData, 500);
        });
    } else {
        // Document already loaded (SPA navigation case)
        setTimeout(initDashboardData, 500);
    }
</script>

<style>
    /* New Dashboard Header */
    .dashboard-header {
        background: var(--bg-secondary);
        padding: 0.5rem 0.4rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        border-bottom: 1px solid var(--border-light);
        min-height: 85px;
    }

    .dashboard-title h2 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-main);
        display: inline-block;
        margin-right: 0.5rem;
    }

    .dashboard-title .subtitle {
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 0.35rem;
        width: 100%;
        max-width: 100%;
        margin: 0;
    }

    .kpi-card {
        padding: 0.5rem 0.5rem;
        border-radius: 6px;
        display: flex;
        justify-content: center;
        /* Center content since icon is gone */
        align-items: center;
        color: white;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
        min-height: 80px;
        max-height: 80px;
        text-align: center;
        /* Center text */
    }

    /* Manage Modal Styling */
    #reportsList {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 400px;
        overflow-y: auto;
        padding-right: 5px;
        /* Space for scrollbar */
    }

    .report-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background: var(--bg-panel);
        border: 1px solid var(--border-light);
        border-radius: 6px;
        transition: background 0.2s;
    }

    .report-row:hover {
        background: var(--surface-2);
    }

    .report-row .name {
        font-weight: 500;
        color: var(--text-main);
    }

    .report-row .date {
        font-size: 0.8em;
        color: var(--text-muted);
    }

    /* Scrollbar for list */
    #reportsList::-webkit-scrollbar {
        width: 6px;
    }

    #reportsList::-webkit-scrollbar-track {
        background: transparent;
    }

    #reportsList::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 3px;
    }

    .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.06) 0%, transparent 50%);
        pointer-events: none;
    }

    .kpi-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.18);
    }

    /* Card Colors with enhanced gradients */
    .card-blue {
        background: linear-gradient(135deg, #4299e1 0%, #3182ce 50%, #2c5aa0 100%);
    }

    .card-orange {
        background: linear-gradient(135deg, #ed8936 0%, #dd6b20 50%, #c05621 100%);
    }

    .card-cyan {
        background: linear-gradient(135deg, #0bc5ea 0%, #0987a0 50%, #067a8e 100%);
    }

    .card-teal {
        background: linear-gradient(135deg, #38b2ac 0%, #319795 50%, #2c7a7b 100%);
    }

    .card-purple {
        background: linear-gradient(135deg, #9f7aea 0%, #805ad5 50%, #6b46c1 100%);
    }

    .card-red {
        background: linear-gradient(135deg, #f56565 0%, #e53e3e 50%, #c53030 100%);
    }

    .kpi-content {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
        z-index: 1;
        flex: 1;
        min-width: 0;
    }

    .kpi-value {
        font-size: 1.25rem;
        font-weight: 700;
        line-height: 1.2;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .kpi-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.4px;
        opacity: 0.9;
        font-weight: 600;
        white-space: nowrap;
        margin-top: 0.2rem;
    }

    /* Dashboard Iframe */
    .dashboard-iframe-wrapper {
        width: 100%;
        flex: 1;
        /* Take remaining space */
        overflow: hidden;
        position: relative;
    }

    .dashboard-iframe {
        width: 100%;
        height: 100%;
        border: none;
        display: block;
    }

    /* Shimmer Loading Effect */
    .shimmer {
        background: var(--bg-panel);
        position: relative;
    }

    .shimmer::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent);
        animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
        0% {
            transform: translateX(-100%);
        }

        100% {
            transform: translateX(100%);
        }
    }



    @media (max-width: 1000px) {
        .kpi-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        .kpi-card {
            min-height: 60px;
            max-height: 60px;
        }

        .kpi-value {
            font-size: 0.9rem;
        }
    }

    @media (max-width: 600px) {
        .kpi-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.4rem;
        }

        .kpi-card {
            padding: 0.5rem;
            min-height: 55px;
            max-height: 55px;
        }

        .kpi-value {
            font-size: 0.85rem;
        }

        .kpi-label {
            font-size: 0.5rem;
        }
    }

    /* Data Button */
    .btn-data {
        background: var(--bg-panel);
        border: 1px solid var(--border-color);
        color: var(--text-main);
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        font-weight: 500;
        font-size: 0.9rem;
        transition: all 0.2s;
    }

    .btn-data:hover {
        background: var(--bg-tertiary, #e2e8f0);
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(2px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s;
    }

    .modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    /* Modal Styles */
    .modal {
        background: var(--bg-secondary);
        width: 900px;
        /* Wider for table */
        max-width: 95vw;
        border-radius: 8px;
        padding: 24px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        border: 1px solid var(--border-color);
        color: var(--text-main);
        display: flex;
        flex-direction: column;
        max-height: 90vh;
    }

    /* Report Select Styles */
    .report-select {
        padding: 8px 12px;
        border-radius: 6px;
        background: var(--bg-panel);
        border: 1px solid var(--border-color);
        color: var(--text-main);
        font-size: 0.9rem;
        cursor: pointer;
        min-width: 200px;
    }

    .report-select:focus {
        outline: none;
        border-color: var(--primary-color);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.25rem;
    }

    .close-modal-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--text-muted);
        cursor: pointer;
    }

    .modal-body {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 20px;
    }

    /* Data Table Styles */
    .data-table-wrapper {
        border: 1px solid var(--border-color);
        border-radius: 4px;
        overflow: hidden;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }

    .data-table th {
        background: var(--bg-tertiary);
        text-align: left;
        padding: 10px 12px;
        font-weight: 600;
        color: var(--text-muted);
        border-bottom: 1px solid var(--border-color);
        position: sticky;
        top: 0;
        z-index: 10;
        box-shadow: 0 1px 0 var(--border-color);
    }

    .data-table td {
        border-bottom: 1px solid var(--border-color);
        padding: 0;
        background: var(--bg-panel);
    }

    .data-table td input,
    .data-table td select {
        width: 100%;
        padding: 10px 12px;
        border: none;
        background: transparent;
        color: var(--text-main);
        font-family: inherit;
        outline: none;
    }

    .data-table td input:focus,
    .data-table td select:focus {
        background: var(--bg-tertiary);
        box-shadow: inset 0 0 0 2px var(--primary-color);
    }

    .action-cell {
        text-align: center;
        width: 40px;
    }

    .btn-delete-row {
        background: none;
        border: none;
        color: #ef4444;
        cursor: pointer;
        padding: 6px;
        border-radius: 4px;
        opacity: 0.7;
    }

    .btn-delete-row:hover {
        opacity: 1;
        background: rgba(239, 68, 68, 0.1);
    }

    .btn-add-row {
        background: transparent;
        border: 1px dashed var(--border-color);
        color: var(--primary-color);
        width: 100%;
        padding: 8px;
        margin-top: 8px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
    }

    .btn-add-row:hover {
        background: rgba(59, 130, 246, 0.05);
        border-color: var(--primary-color);
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 24px;
    }

    .btn-cancel {
        background: transparent;
        border: 1px solid var(--border-color);
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        color: var(--text-main);
    }

    .btn-save {
        background: #3b82f6;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        color: white;
    }
</style>