<div class="page-container" id="dashboard-page">
    <div class="dashboard-header">
        <div class="dashboard-title">
            <h2>Sales Dashboard</h2>
            <span class="subtitle">Overview</span>
        </div>

        <!-- Injected Stats Grid -->
        <div class="kpi-grid" id="dashboard-stats">
            <!-- Stats inserted via JS -->
            <div class="kpi-card card-blue shimmer"></div>
            <div class="kpi-card card-orange shimmer"></div>
            <div class="kpi-card card-cyan shimmer"></div>
            <div class="kpi-card card-purple shimmer"></div>
            <div class="kpi-card card-red shimmer"></div>
        </div>
    </div>

    <!-- Map Content -->
    <div class="dashboard-iframe-wrapper">
        <iframe src="pages/map.html" frameborder="0" class="dashboard-iframe" title="Sales Intelligence Map"></iframe>
    </div>
</div>

<script>
    console.log('Dashboard script loaded');
    window.addEventListener('message', function (event) {
        if (event.data.type === 'STATS_UPDATE') {
            const data = event.data.data;
            const container = document.getElementById('dashboard-stats');

            if (container) {
                // Determine Achievement Color/Status
                // Reference uses colors for cards, so we stick to the card theme colors
                // But we can add an icon or indicator if needed.

                container.innerHTML = `
                    <!-- Population (Placeholder) -->
                    <div class="kpi-card card-blue">
                        <div class="kpi-content">
                            <span class="kpi-value">3.5 Cr</span>
                            <span class="kpi-label">Population</span>
                        </div>
                        <div class="kpi-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                        </div>
                    </div>

                    <!-- Dealers -->
                    <div class="kpi-card card-orange">
                        <div class="kpi-content">
                            <span class="kpi-value">${data.dealerCount}</span>
                            <span class="kpi-label">Active Dealers</span>
                        </div>
                        <div class="kpi-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18v18H3zM9 9h6v6H9z"/></svg>
                        </div>
                    </div>

                    <!-- Sales -->
                    <div class="kpi-card card-cyan">
                        <div class="kpi-content">
                            <span class="kpi-value">₹${formatCurrency(data.currentSales)}</span>
                            <span class="kpi-label">Total Sales</span>
                        </div>
                        <div class="kpi-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                        </div>
                    </div>

                    <!-- Achievement -->
                    <div class="kpi-card card-purple">
                        <div class="kpi-content">
                            <span class="kpi-value">${formatNumber(data.achievement)}%</span>
                            <span class="kpi-label">Achievement</span>
                        </div>
                        <div class="kpi-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                        </div>
                    </div>

                    <!-- Target -->
                    <div class="kpi-card card-red">
                        <div class="kpi-content">
                            <span class="kpi-value">₹${formatCurrency(data.monthlyTarget)}</span>
                            <span class="kpi-label">Monthly Target</span>
                        </div>
                        <div class="kpi-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>
                        </div>
                    </div>
                `;
            }
        }
    });

    function formatNumber(num) {
        if (!num) return '0';
        return parseFloat(num).toFixed(1);
    }

    function formatCurrency(val) {
        if (!val) return '0';
        let num = parseFloat(val);
        if (isNaN(num)) return val;
        // Indian Number System
        if (num >= 10000000) return (num / 10000000).toFixed(2) + ' Cr';
        else if (num >= 100000) return (num / 100000).toFixed(2) + ' L';
        else if (num >= 1000) return (num / 1000).toFixed(1) + ' k';
        return num.toFixed(0);
    }
</script>

<style>
    /* New Dashboard Header */
    .dashboard-header {
        background: var(--bg-secondary);
        padding: 1rem 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        border-bottom: 1px solid var(--border-light);
        min-height: 120px;
        /* Double height approx */
    }

    .dashboard-title h2 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-main);
        display: inline-block;
        margin-right: 0.5rem;
    }

    .dashboard-title .subtitle {
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
        width: 100%;
    }

    .kpi-card {
        padding: 1rem;
        border-radius: 6px;
        /* Slightly rounded, VS Code style */
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: white;
        /* Always white text on colored cards */
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
        position: relative;
        overflow: hidden;
    }

    .kpi-card:hover {
        transform: translateY(-2px);
    }

    /* Card Colors */
    .card-blue {
        background: linear-gradient(135deg, #4299e1, #3182ce);
    }

    .card-orange {
        background: linear-gradient(135deg, #ed8936, #dd6b20);
    }

    .card-cyan {
        background: linear-gradient(135deg, #0bc5ea, #0987a0);
    }

    .card-purple {
        background: linear-gradient(135deg, #9f7aea, #805ad5);
    }

    .card-red {
        background: linear-gradient(135deg, #f56565, #e53e3e);
    }

    .kpi-content {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .kpi-value {
        font-size: 1.4rem;
        font-weight: 700;
        line-height: 1.2;
    }

    .kpi-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        opacity: 0.9;
        font-weight: 500;
    }

    .kpi-icon {
        opacity: 0.25;
        transform: scale(1.5);
    }

    /* Dashboard Iframe */
    .dashboard-iframe-wrapper {
        width: 100%;
        flex: 1;
        /* Take remaining space */
        overflow: hidden;
        position: relative;
    }

    .dashboard-iframe {
        width: 100%;
        height: 100%;
        border: none;
        display: block;
    }

    /* Shimmer Loading Effect */
    .shimmer {
        background: var(--bg-panel);
        position: relative;
    }

    .shimmer::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent);
        animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
        0% {
            transform: translateX(-100%);
        }

        100% {
            transform: translateX(100%);
        }
    }

    @media (max-width: 1000px) {
        .kpi-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 600px) {
        .kpi-grid {
            grid-template-columns: 1fr;
        }
    }
</style>