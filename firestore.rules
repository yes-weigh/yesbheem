rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    // Check if the user is authenticated and NOT suspended (Kill Switch)
    function isActiveUser() {
      return request.auth != null &&
             (
               !exists(/databases/$(database)/documents/users/$(request.auth.uid)) ||
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.suspended != true
             );
    }

    // Check if the user is using a Trusted Device (Hardware Binding)
    function isTrustedDevice() {
      return request.auth.token.keys().hasAny(['trustedDevice']) && request.auth.token.trustedDevice == true;
    }

    // --- Collection Rules ---

    // Default Deny
    match /{document=**} {
      allow read, write: if false;
    }

    // Users Profile
    match /users/{userId} {
      // User can read their own profile; Admin can read all (for Security Dashboard)
      allow read: if (isActiveUser() && request.auth.uid == userId) || request.auth.token.role == 'admin';
      
      // Allow users to update their own document (for logout session cleanup)
      allow update: if request.auth.uid == userId;
      
      // Admin can do everything (create, update, delete)
      allow write: if request.auth.token.role == 'admin'; 
    }

    // Security Audit Logs (Traitor Tracking)
    // Security Audit Logs (Traitor Tracking)
    match /security_audit/{logId} {
      // Allow creation of logs by any authenticated user
      allow create: if request.auth != null;
      // Admin can read logs
      allow read: if request.auth.token.role == 'admin';
      allow update, delete: if false; 
    }

    // NEW: Detailed User Activity Logs (Login, Action History)
    match /user_activity_logs/{logId} {
      allow create: if request.auth != null; // Log actions from client
      allow read: if request.auth.token.role == 'admin'; // Admin dashboard
      allow update, delete: if false; // Immutable
    }

    // Role-Based Access Control (RBAC) - Admin Only
    match /authorized_users/{email} {
      allow read, write: if request.auth.token.role == 'admin';
    }

    // Temp OTPs (for auth flow)
    match /temp_otps/{email} {
      // Only readable by the auth functions (Admin SDK) - so deny client access
      allow read, write: if false;
    }

    // General Collections (Sales, Dealers, etc.) - Applying strict security
    match /dealers/{dealerId} {
      allow read: if isActiveUser() && isTrustedDevice();
      allow write: if isActiveUser() && isTrustedDevice();
    }
    
    match /sales_data/{docId} {
      allow read: if isActiveUser() && isTrustedDevice();
      allow write: if isActiveUser() && isTrustedDevice();
    }
    
    // General Collections
    match /dealers/{dealerId} {
      allow read: if isActiveUser() && isTrustedDevice();
      allow write: if isActiveUser() && isTrustedDevice();
    }
    
    match /sales_data/{docId} {
      allow read: if isActiveUser() && isTrustedDevice();
      allow write: if isActiveUser() && isTrustedDevice();
    }
    
    // Configuration Documents (All stored in 'settings' collection)
    match /settings/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // WhatsApp Instances Metadata
    match /whatsapp_instances/{docId} {
      allow read, write: if request.auth != null;
    }

    // Report Data (Actual CSV content stored in separate collection)
    match /reports_data/{docId} {
      allow read: if request.auth != null;
      allow write: if isActiveUser() && isTrustedDevice();
    }

    // Task Management Rules
    match /task_boards/{boardId} {
      allow read, write: if (isActiveUser() && isTrustedDevice()) || request.auth.token.role == 'admin';
    }
    
    match /project_tasks/{taskId} {
      allow read, write: if (isActiveUser() && isTrustedDevice()) || request.auth.token.role == 'admin';
    }

    // Broad fallback for other collections (Be careful here, usually better to start with specific)
    // For now, let's enforce Active + Trusted for anything else the app might use
    // match /{path=**}/documents {
    //   allow read: if isActiveUser() && isTrustedDevice();
    // }
  }
}
