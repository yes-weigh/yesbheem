<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth Testing Dashboard</title>
    <style>
        body { font-family: monospace; padding: 20px; max-width: 800px; margin: 0 auto; background: #1a1a1a; color: #fff; }
        .container { display: flex; flex-direction: column; gap: 15px; }
        input, button { padding: 10px; background: #333; border: 1px solid #444; color: #fff; font-family: inherit; }
        button { cursor: pointer; background: #444; }
        button:hover { background: #555; }
        #logs { background: #000; border: 1px solid #333; padding: 10px; height: 300px; overflow-y: auto; margin-top: 20px; white-space: pre-wrap; color: #0f0; }
        .hidden { display: none; }
        .section { border: 1px solid #333; padding: 15px; margin-bottom: 20px; }
        h2 { margin-top: 0; }
    </style>
</head>
<body>
    <h1>Auth Testing Dashboard</h1>
    
    <div class="section">
        <h2>1. Trigger Dispatch</h2>
        <div class="container">
            <input type="email" id="testEmail" placeholder="Test Email" value="test@example.com">
            <input type="text" id="testPhoneNumber" placeholder="Test Phone Number (e.g., 919876543210)">
            <input type="text" id="deviceFingerprint" placeholder="Device Fingerprint" value="test-device-fp-123">
            <button id="triggerBtn">Trigger Dispatch (sendDualSplitOTP)</button>
        </div>
    </div>

    <div id="verifySection" class="section hidden">
        <h2>2. Verify Codes</h2>
        <div class="container">
            <input type="text" id="codeA" placeholder="WhatsApp Code (Part A)">
            <input type="text" id="codeB" placeholder="Email Code (Part B)">
            <button id="verifyBtn">Verify Codes (verifySplitOTP)</button>
        </div>
    </div>

    <div class="section">
        <h2>Logs & Results</h2>
        <div id="logs"></div>
    </div>

    <script type="module">
        import { app } from './js/services/firebase_config.js';
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js";

        // Initialize Cloud Functions (Default region us-central1)
        const functions = getFunctions(app, 'us-central1');

        // UI References
        const testEmail = document.getElementById('testEmail');
        const testPhoneNumber = document.getElementById('testPhoneNumber');
        const deviceFingerprint = document.getElementById('deviceFingerprint');
        const triggerBtn = document.getElementById('triggerBtn');
        const verifySection = document.getElementById('verifySection');
        const codeA = document.getElementById('codeA');
        const codeB = document.getElementById('codeB');
        const verifyBtn = document.getElementById('verifyBtn');
        const logs = document.getElementById('logs');

        function log(message, type = 'info') {
            const timestamp = new Date().toISOString();
            const entry = document.createElement('div');
            entry.textContent = `[${timestamp}] [${type}] ${message}`;
            entry.style.color = type === 'error' ? '#ff6b6b' : (type === 'success' ? '#69db7c' : '#0f0');
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
            console.log(`[${type}]`, message);
        }

        async function triggerDispatch() {
            const email = testEmail.value;
            const phone = testPhoneNumber.value;
            const fp = deviceFingerprint.value;

            if (!email || !phone || !fp) {
                log('Please fill all fields in Trigger Dispatch section', 'error');
                return;
            }

            log(`Starting sendDualSplitOTP... Email: ${email}, Phone: ${phone}`);
            triggerBtn.disabled = true;
            const startTime = Date.now();

            try {
                const sendDualSplitOTP = httpsCallable(functions, 'sendDualSplitOTP');
                const result = await sendDualSplitOTP({
                    email: email,
                    phoneNumber: phone,
                    deviceFingerprint: fp
                });

                const latency = Date.now() - startTime;
                log(`Success! Latency: ${latency}ms`, 'success');
                log(`Result: ${JSON.stringify(result.data, null, 2)}`);
                
                verifySection.classList.remove('hidden');
                
            } catch (error) {
                const latency = Date.now() - startTime;
                log(`Error after ${latency}ms: ${error.message}`, 'error');
                log(JSON.stringify(error, Object.getOwnPropertyNames(error), 2), 'error');
            } finally {
                triggerBtn.disabled = false;
            }
        }

        async function verifyCodes() {
            const cA = codeA.value;
            const cB = codeB.value;
            const email = testEmail.value;
            const fp = deviceFingerprint.value;

            if (!cA || !cB) {
                log('Please enter both codes', 'error');
                return;
            }

            log(`Starting verifySplitOTP... CodeA: ${cA}, CodeB: ${cB}`);
            verifyBtn.disabled = true;
            const startTime = Date.now();

            try {
                const verifySplitOTP = httpsCallable(functions, 'verifySplitOTP');
                const result = await verifySplitOTP({
                    email: email,
                    codeA: cA,
                    codeB: cB,
                    deviceFingerprint: fp
                });

                const latency = Date.now() - startTime;
                log(`Verification Success! Latency: ${latency}ms`, 'success');
                log('Received Custom Token and Data:');
                log(JSON.stringify(result.data, null, 2));

            } catch (error) {
                const latency = Date.now() - startTime;
                log(`Verification Error after ${latency}ms: ${error.message}`, 'error');
                log(JSON.stringify(error, Object.getOwnPropertyNames(error), 2), 'error');
            } finally {
                verifyBtn.disabled = false;
            }
        }

        triggerBtn.addEventListener('click', triggerDispatch);
        verifyBtn.addEventListener('click', verifyCodes);

        log('Auth Testing Dashboard Initialized');
    </script>
</body>
</html>
